name: æ›´æ–°Steamæ¸¸æˆæ•°æ®

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´å‡Œæ™¨1ç‚¹ï¼‰
  schedule:
    - cron: '0 1 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      games_limit:
        description: 'è¦è·å–çš„æ¸¸æˆæ•°é‡'
        required: false
        default: '50'
        type: string
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰æ•°æ®'
        required: false
        default: false
        type: boolean

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        # éœ€è¦å®Œæ•´çš„gitå†å²æ¥è¿›è¡Œæäº¤
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        npm install
        # å¦‚æœéœ€è¦é¢å¤–çš„ä¾èµ–ï¼Œå¯ä»¥åœ¨è¿™é‡Œå®‰è£…
        # npm install axios cheerio
    
    - name: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: åˆ›å»ºæ•°æ®ç›®å½•
      run: |
        mkdir -p public/data
        mkdir -p cache
        mkdir -p logs
    
    - name: è¿è¡Œæ•°æ®æ‹‰å–è„šæœ¬
      env:
        GAMES_LIMIT: ${{ github.event.inputs.games_limit || '50' }}
        FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
        NODE_ENV: production
      run: |
        echo "å¼€å§‹æ‹‰å–Steamæ•°æ®..."
        echo "æ¸¸æˆæ•°é‡é™åˆ¶: $GAMES_LIMIT"
        echo "å¼ºåˆ¶æ›´æ–°: $FORCE_UPDATE"
        
        # è®¾ç½®è„šæœ¬æƒé™
        chmod +x scripts/data-fetcher.js
        
        # è¿è¡Œæ•°æ®æ‹‰å–è„šæœ¬
        node scripts/data-fetcher.js 2>&1 | tee logs/data-fetch-$(date +%Y%m%d).log
        
        echo "æ•°æ®æ‹‰å–å®Œæˆ"
    
    - name: æ£€æŸ¥æ•°æ®æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶..."
        ls -la public/data/
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "public/data/metadata.json" ]; then
          echo "âŒ å…ƒæ•°æ®æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        if [ ! -f "public/data/game-details.json" ]; then
          echo "âŒ æ¸¸æˆè¯¦æƒ…æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        metadata_size=$(stat -c%s "public/data/metadata.json")
        games_size=$(stat -c%s "public/data/game-details.json")
        
        echo "å…ƒæ•°æ®æ–‡ä»¶å¤§å°: $metadata_size bytes"
        echo "æ¸¸æˆè¯¦æƒ…æ–‡ä»¶å¤§å°: $games_size bytes"
        
        if [ $metadata_size -lt 100 ] || [ $games_size -lt 1000 ]; then
          echo "âŒ æ•°æ®æ–‡ä»¶å¼‚å¸¸å°ï¼Œå¯èƒ½æ‹‰å–å¤±è´¥"
          exit 1
        fi
        
        echo "âœ… æ•°æ®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
    
    - name: ç”Ÿæˆæ•°æ®ç»Ÿè®¡æŠ¥å‘Š
      run: |
        echo "ç”Ÿæˆæ•°æ®ç»Ÿè®¡æŠ¥å‘Š..."
        node -e "
        const fs = require('fs');
        const path = require('path');
        
        try {
          const metadata = JSON.parse(fs.readFileSync('public/data/metadata.json', 'utf-8'));
          const gameDetails = JSON.parse(fs.readFileSync('public/data/game-details.json', 'utf-8'));
          
          console.log('ğŸ“Š æ•°æ®ç»Ÿè®¡æŠ¥å‘Š');
          console.log('================');
          console.log('æ›´æ–°æ—¶é—´:', metadata.lastUpdated);
          console.log('æ¸¸æˆæ€»æ•°:', metadata.gamesCount);
          console.log('çƒ­é—¨æ¸¸æˆæ•°:', metadata.popularGamesCount);
          console.log('ä»·æ ¼å†å²è®°å½•æ•°:', metadata.priceHistoryCount);
          console.log('æ•°æ®æº:', metadata.dataSource);
          console.log('ç‰ˆæœ¬:', metadata.version);
          console.log('');
          
          // ç»Ÿè®¡æ¸¸æˆç±»å‹
          const gameTypes = {};
          const developers = {};
          
          gameDetails.forEach(game => {
            gameTypes[game.type] = (gameTypes[game.type] || 0) + 1;
            developers[game.developer] = (developers[game.developer] || 0) + 1;
          });
          
          console.log('æ¸¸æˆç±»å‹åˆ†å¸ƒ:');
          Object.entries(gameTypes)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5)
            .forEach(([type, count]) => {
              console.log(' -', type, ':', count);
            });
          
          console.log('');
          console.log('ä¸»è¦å¼€å‘å•†:');
          Object.entries(developers)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5)
            .forEach(([dev, count]) => {
              console.log(' -', dev, ':', count);
            });
            
        } catch (error) {
          console.error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥:', error.message);
        }
        "
    
    - name: ä¸Šä¼ æ•°æ®æ–‡ä»¶ä¸ºæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: steam-data-${{ github.run_number }}
        path: |
          public/data/
          logs/
        retention-days: 7
    
    - name: æ£€æŸ¥GitçŠ¶æ€
      run: |
        echo "æ£€æŸ¥GitçŠ¶æ€..."
        git status
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æœªè·Ÿè¸ªçš„æ–‡ä»¶
        if [ -n "$(git ls-files --others --exclude-standard)" ]; then
          echo "å‘ç°æ–°æ–‡ä»¶ï¼Œæ·»åŠ åˆ°Git..."
          git add .
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ•°æ®æ›´æ”¹"
          echo "SKIP_COMMIT=true" >> $GITHUB_ENV
        else
          echo "æ£€æµ‹åˆ°æ•°æ®æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
          echo "SKIP_COMMIT=false" >> $GITHUB_ENV
        fi
    
    - name: æäº¤å’Œæ¨é€æ›´æ”¹
      if: env.SKIP_COMMIT == 'false'
      run: |
        echo "æäº¤æ•°æ®æ›´æ”¹..."
        
        # è·å–å½“å‰æ—¶é—´
        current_date=$(date +'%Y-%m-%d %H:%M')
        
        # è·å–æ¸¸æˆæ•°é‡
        games_count=$(node -e "
          try {
            const metadata = JSON.parse(require('fs').readFileSync('public/data/metadata.json', 'utf-8'));
            console.log(metadata.gamesCount);
          } catch(e) {
            console.log('æœªçŸ¥');
          }
        ")
        
        # åˆ›å»ºæäº¤ä¿¡æ¯
        commit_message="ğŸ® è‡ªåŠ¨æ›´æ–°Steamæ¸¸æˆæ•°æ®
        ğŸ“… æ›´æ–°æ—¶é—´: $current_date
        ğŸ¯ æ¸¸æˆæ•°é‡: $games_count
        ğŸ¤– è‡ªåŠ¨åŒ–ä»»åŠ¡: GitHub Actions
        ğŸ“Š æ•°æ®æ¥æº: SteamSpy + Steam Store API
        é€šè¿‡GitHub Actionsè‡ªåŠ¨æ‹‰å–å¹¶æ›´æ–°Steamæ¸¸æˆæ•°æ®"
        
        git commit -m "$commit_message"
        git push
        
        echo "âœ… æ•°æ®å·²æˆåŠŸæäº¤åˆ°GitHub"
        
        # è¾“å‡ºæäº¤ä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "COMMIT_MESSAGE<<EOF" >> $GITHUB_ENV
        echo "$commit_message" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
    
    - name: åˆ›å»ºå‘å¸ƒæ ‡ç­¾ï¼ˆæ¯å‘¨ï¼‰
      if: env.SKIP_COMMIT == 'false' && github.event.schedule == '0 1 * * 0'
      run: |
        # æ¯å‘¨æ—¥åˆ›å»ºä¸€ä¸ªå‘å¸ƒæ ‡ç­¾
        tag_name="data-$(date +'%Y%m%d')"
        
        git tag -a "$tag_name" -m "Steamæ•°æ®å¿«ç…§ - $(date +'%Yå¹´%mæœˆ%dæ—¥')"
        git push origin "$tag_name"
        
        echo "åˆ›å»ºå‘å¸ƒæ ‡ç­¾: $tag_name"
    
    - name: å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      if: env.SKIP_COMMIT == 'false' && failure()
      run: |
        echo "æ•°æ®æ›´æ–°å¤±è´¥ï¼Œå‘é€é€šçŸ¥..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œæ¯”å¦‚å‘é€é‚®ä»¶æˆ–Webhook
        # curl -X POST "your-webhook-url" -d "æ•°æ®æ›´æ–°å¤±è´¥"
    
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        # æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
        rm -rf cache/*
        rm -rf logs/*.tmp
        
        echo "æ¸…ç†å®Œæˆ"
    
    - name: ä»»åŠ¡å®Œæˆæ‘˜è¦
      if: always()
      run: |
        echo "ğŸ“‹ ä»»åŠ¡æ‰§è¡Œæ‘˜è¦"
        echo "================"
        echo "æ‰§è¡Œæ—¶é—´: $(date)"
        echo "è·³è¿‡æäº¤: $SKIP_COMMIT"
        echo "ä»»åŠ¡çŠ¶æ€: ${{ job.status }}"
        
        if [ -f "public/data/metadata.json" ]; then
          echo "æœ€æ–°æ•°æ®ä¿¡æ¯:"
          cat public/data/metadata.json | head -10
        fi 