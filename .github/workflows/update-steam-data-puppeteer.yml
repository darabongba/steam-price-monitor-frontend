name: ğŸ¤– æ›´æ–°Steamæ•°æ®å¹¶éƒ¨ç½² (Puppeteerç‰ˆ)

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹è¿è¡Œ (UTC+8 = UTC+0-8)
    - cron: '0 1 * * *'

  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'puppeteer'
        type: choice
        options:
          - puppeteer
          - standard
      games_limit:
        description: 'æ¸¸æˆæ•°é‡é™åˆ¶'
        required: false
        default: '30'
        type: string
      deploy:
        description: 'æ˜¯å¦éƒ¨ç½²åˆ°GitHub Pages'
        required: false
        default: true
        type: boolean

# æƒé™é…ç½®
permissions:
  contents: write
  actions: read
  pages: write
  id-token: write

jobs:
  update-steam-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.DEPLOY_TOKEN }}
        fetch-depth: 0

    - name: ğŸ“¦ å®‰è£…pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 8

    - name: ğŸŸ¢ è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ—ï¸ æ„å»ºå‰ç«¯é¡¹ç›®
      if: steps.fetch_data.outputs.data_generated == 'true'
      run: |
        echo "ğŸ—ï¸ å¼€å§‹æ„å»ºå‰ç«¯é¡¹ç›®..." 
        
        # å®‰è£…å‰ç«¯ä¾èµ–
        pnpm install
        
        # æ„å»ºé¡¹ç›®
        pnpm run build
        
        # æ£€æŸ¥æ„å»ºäº§ç‰©
        if [ -d "dist" ]; then
          echo "âœ… æ„å»ºæˆåŠŸï¼Œäº§ç‰©å¤§å°:" 
          du -sh dist/ 
          ls -la dist/ 
        else
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°distç›®å½•" 
          exit 1
        fi
      env:
        NODE_ENV: production

    - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
      if: steps.fetch_data.outputs.data_generated == 'true' && (github.event.inputs.deploy == 'true' || github.event.inputs.deploy == true)
      run: |
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°GitHub Pages..." 
        
        # æ£€æŸ¥æ˜¯å¦é…ç½®äº†éƒ¨ç½²å¯†é’¥
        if [ -z "${{ secrets.DEPLOY_TOKEN }}" ]; then
          echo "âš ï¸ æœªé…ç½®DEPLOY_TOKENï¼Œä½¿ç”¨é»˜è®¤DEPLOY_TOKENï¼ˆå¯èƒ½æƒé™ä¸è¶³ï¼‰" 
          DEPLOY_TOKEN="${{ secrets.DEPLOY_TOKEN }}"
        else
          echo "âœ… ä½¿ç”¨é…ç½®çš„DEPLOY_TOKEN" 
          DEPLOY_TOKEN="${{ secrets.DEPLOY_TOKEN }}"
        fi
        
        # å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆä½¿ç”¨tokenè®¤è¯ï¼‰
        git clone https://${DEPLOY_TOKEN}@github.com/steamMonitor/steamMonitor.github.io.git pages-repo
        cd pages-repo
        
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config user.email "action@github.com"
        git config user.name "GitHub Action Bot"
        
        # æ£€æŸ¥å½“å‰åˆ†æ”¯
        current_branch=$(git branch --show-current)
        echo "ğŸ“‹ å½“å‰åˆ†æ”¯: $current_branch" | tee -a ../logs/fetch.log
        
        # å¦‚æœä¸æ˜¯mainåˆ†æ”¯ï¼Œåˆ‡æ¢åˆ°mainåˆ†æ”¯
        if [ "$current_branch" != "main" ]; then
          git checkout -b main 2>/dev/null || git checkout main
        fi
        
        # æ¸…ç©ºç°æœ‰å†…å®¹ï¼ˆä¿ç•™.gitç›®å½•å’ŒREADME.mdï¼‰
        find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' ! -name 'README.md' -exec rm -rf {} +
        
        # å¤åˆ¶æ„å»ºäº§ç‰©
        cp -r ../dist/* .
        
        # æ·»åŠ CNAMEæ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦è‡ªå®šä¹‰åŸŸåï¼Œè¯·å–æ¶ˆæ³¨é‡Šå¹¶ä¿®æ”¹åŸŸåï¼‰
        # echo "steam-monitor.youseeyou1daydayde.uk" > CNAME
        
                 # æ·»åŠ .nojekyllæ–‡ä»¶ä»¥ç¦ç”¨Jekyllå¤„ç†
         touch .nojekyll
         
         # æ·»åŠ ç®€å•çš„READMEæ–‡ä»¶
         echo "# Steam Price Monitor" > README.md
         echo "" >> README.md
         echo "Steamä»·æ ¼ç›‘æ§åº”ç”¨ - è‡ªåŠ¨éƒ¨ç½²äº $(date '+%Y-%m-%d %H:%M:%S UTC')" >> README.md
         echo "" >> README.md
         echo "è®¿é—®: https://steammonitor.github.io" >> README.md
        
        # æäº¤å¹¶å¼ºåˆ¶æ¨é€
        git add .
        
        if git diff --cached --quiet; then
          echo "ğŸ“ æ„å»ºäº§ç‰©æ— å˜åŒ–ï¼Œè·³è¿‡éƒ¨ç½²" | tee -a ../logs/fetch.log
        else
          GAMES_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('../public/data/metadata.json', 'utf8')).gamesCount)" 2>/dev/null || echo "æœªçŸ¥")
          
          git commit -m "ğŸš€ è‡ªåŠ¨éƒ¨ç½²Steamä»·æ ¼ç›‘æ§åº”ç”¨ - $(date '+%Y-%m-%d %H:%M') - ${GAMES_COUNT}ä¸ªæ¸¸æˆ [skip ci]"
          
          echo "ğŸ“¤ å¼ºåˆ¶æ¨é€åˆ°GitHub Pages..." | tee -a ../logs/fetch.log
          git push --force origin main
          
          echo "âœ… éƒ¨ç½²å®Œæˆ!" | tee -a ../logs/fetch.log
          echo "ğŸŒ è®¿é—®åœ°å€: https://steammonitor.github.io" | tee -a ../logs/fetch.log
        fi
        
        cd ..
        rm -rf pages-repo
      env:
        DEPLOY_TOKEN: ${{  secrets.DEPLOY_TOKEN }}

    - name: ğŸ“‹ ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: fetch-logs-${{ github.run_number }}
        path: logs/
        retention-days: 7

    - name: ğŸ“Š è¿è¡Œç»“æœæ€»ç»“
      if: always()
      run: |
        echo "=== ğŸš€ Steamæ•°æ®æ›´æ–°å’Œéƒ¨ç½²ä»»åŠ¡å®Œæˆ ===" 
        echo "â° è¿è¡Œæ—¶é—´: $(date)" 
        echo "ğŸ”§ è¿è¡Œæ¨¡å¼: ${{ github.event.inputs.mode || 'puppeteer' }}" 
        echo "ğŸ“Š ä»»åŠ¡çŠ¶æ€: ${{ job.status }}" 
        
        if [ "${{ steps.fetch_data.outputs.data_generated }}" = "true" ]; then
          echo "âœ… æ•°æ®ç”Ÿæˆ: æˆåŠŸ" 
          echo "âœ… å‰ç«¯æ„å»º: æˆåŠŸ" 
          
          if [ "${{ github.event.inputs.deploy }}" = "true" ] || [ "${{ github.event.inputs.deploy }}" = "" ]; then
            echo "âœ… GitHub Pageséƒ¨ç½²: æˆåŠŸ" 
            echo "ğŸŒ è®¿é—®åœ°å€: https://steammonitor.github.io" 
          else
            echo "â­ï¸ GitHub Pageséƒ¨ç½²: è·³è¿‡ï¼ˆæ‰‹åŠ¨ç¦ç”¨ï¼‰" 
          fi
        else
          echo "âŒ æ•°æ®ç”Ÿæˆ: å¤±è´¥" 
          echo "â­ï¸ å‰ç«¯æ„å»º: è·³è¿‡" 
          echo "â­ï¸ GitHub Pageséƒ¨ç½²: è·³è¿‡" 
        fi
        
        if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
          echo "âœ… æ•°æ®æäº¤: æˆåŠŸ" 
        else
          echo "ğŸ“ æ•°æ®æäº¤: æ— å˜åŒ–" 
        fi
        
        echo "ğŸ“ æ—¥å¿—æ–‡ä»¶å·²ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©" 
        
        # æ˜¾ç¤ºæœ€åå‡ è¡Œæ—¥å¿—
        echo "=== æœ€è¿‘çš„æ—¥å¿— ===" 
        tail -20 logs/fetch.log