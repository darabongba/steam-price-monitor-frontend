name: ğŸ¤– æ›´æ–°Steamæ•°æ®å¹¶éƒ¨ç½² (Puppeteerç‰ˆ)

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹è¿è¡Œ (UTC+8 = UTC+0-8)
    - cron: '0 1 * * *'

  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'puppeteer'
        type: choice
        options:
          - puppeteer
          - standard
      games_limit:
        description: 'æ¸¸æˆæ•°é‡é™åˆ¶'
        required: false
        default: '30'
        type: string
      deploy:
        description: 'æ˜¯å¦éƒ¨ç½²åˆ°GitHub Pages'
        required: false
        default: true
        type: boolean

# æƒé™é…ç½®
permissions:
  contents: write
  actions: read
  pages: write
  id-token: write

jobs:
  update-steam-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.DEPLOY_TOKEN }}
          fetch-depth: 0

      - name: ğŸ“¦ å®‰è£…pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸŸ¢ è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pnpm install --no-frozen-lockfile

      - name: ğŸ”§ å®‰è£…Chromeä¾èµ– (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            fonts-liberation \
            libappindicator3-1 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libcups2 \
            libdbus-1-3 \
            libgdk-pixbuf2.0-0 \
            libnspr4 \
            libnss3 \
            libx11-xcb1 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            xdg-utils \
            libxss1 \
            libxtst6 \
            libgtk-3-0 \
            libdrm2 \
            libxkbcommon0 \
            libgbm1

      - name: ğŸŒ è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
          echo "PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=false" >> $GITHUB_ENV
          echo "PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable" >> $GITHUB_ENV

      - name: ğŸ—‚ï¸ åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          mkdir -p public/data
          mkdir -p cache
          mkdir -p logs

      - name: ğŸ“Š è¿è¡Œæ•°æ®æ‹‰å– (Puppeteeræ¨¡å¼)
        id: fetch_data
        run: |
          echo "å¼€å§‹æ—¶é—´: $(date)" | tee logs/fetch.log
          
          # æ ¹æ®è¾“å…¥é€‰æ‹©è¿è¡Œæ¨¡å¼
          if [ "${{ github.event.inputs.mode }}" = "standard" ]; then
            echo "ä½¿ç”¨æ ‡å‡†æ¨¡å¼..." | tee -a logs/fetch.log
            timeout 25m node scripts/data-fetcher.cjs 2>&1 | tee -a logs/fetch.log
          else
            echo "ä½¿ç”¨Puppeteeræ¨¡å¼..." | tee -a logs/fetch.log
            # æ³¨æ„ï¼šGitHub Actionsç¯å¢ƒä¸‹ä¸ä½¿ç”¨ä»£ç†
            timeout 25m node scripts/data-fetcher-puppeteer.cjs 2>&1 | tee -a logs/fetch.log
          fi
          
          echo "ç»“æŸæ—¶é—´: $(date)" | tee -a logs/fetch.log
          
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æ•°æ®æ–‡ä»¶
          if [ -f "public/data/metadata.json" ]; then
            echo "data_generated=true" >> $GITHUB_OUTPUT
            echo "âœ… æ•°æ®ç”ŸæˆæˆåŠŸ" | tee -a logs/fetch.log
          else
            echo "data_generated=false" >> $GITHUB_OUTPUT
            echo "âŒ æ•°æ®ç”Ÿæˆå¤±è´¥" | tee -a logs/fetch.log
            exit 1
          fi
        env:
          NODE_ENV: production
          # GitHub Actionsç¯å¢ƒä¸‹ç¦ç”¨ä»£ç†
          NO_PROXY: true
        continue-on-error: false

      - name: ğŸ“ˆ æ•°æ®ç»Ÿè®¡å’ŒéªŒè¯
        if: steps.fetch_data.outputs.data_generated == 'true'
        run: |
          echo "=== æ•°æ®ç»Ÿè®¡æŠ¥å‘Š ===" | tee -a logs/fetch.log
          
          # æ£€æŸ¥å„ä¸ªæ•°æ®æ–‡ä»¶
          for file in popular-games.json game-details.json price-history.json search-index.json metadata.json; do
            if [ -f "public/data/$file" ]; then
              size=$(stat -f%z "public/data/$file" 2>/dev/null || stat -c%s "public/data/$file" 2>/dev/null || echo "0")
              echo "ğŸ“„ $file: ${size} bytes" | tee -a logs/fetch.log
            else
              echo "âŒ $file: æ–‡ä»¶ä¸å­˜åœ¨" | tee -a logs/fetch.log
            fi
          done
          
          # è§£æmetadata.jsonè·å–ç»Ÿè®¡ä¿¡æ¯
          if [ -f "public/data/metadata.json" ]; then
            echo "=== è¯¦ç»†ç»Ÿè®¡ ===" | tee -a logs/fetch.log
            node -e "
              const fs = require('fs');
              const metadata = JSON.parse(fs.readFileSync('public/data/metadata.json', 'utf8'));
              console.log(\`ğŸ® æ¸¸æˆæ€»æ•°: \${metadata.gamesCount}\`);
              console.log(\`ğŸ”¥ çƒ­é—¨æ¸¸æˆ: \${metadata.popularGamesCount}\`);
              console.log(\`ğŸ“ˆ ä»·æ ¼å†å²: \${metadata.priceHistoryCount}\`);
              console.log(\`ğŸ”§ æ•°æ®æº: \${metadata.dataSource}\`);
              console.log(\`â° æ›´æ–°æ—¶é—´: \${metadata.lastUpdated}\`);
              console.log(\`ğŸ“Š ç‰ˆæœ¬: \${metadata.version}\`);
              if (metadata.requestStats) {
                console.log(\`ğŸŒ è¯·æ±‚ç»Ÿè®¡: \${JSON.stringify(metadata.requestStats, null, 2)}\`);
              }
            " | tee -a logs/fetch.log
          fi
          
          echo "=== æ•°æ®è´¨é‡æ£€æŸ¥ ===" | tee -a logs/fetch.log
          node -e "
            const fs = require('fs');
            try {
              const games = JSON.parse(fs.readFileSync('public/data/game-details.json', 'utf8'));
              const withDesc = games.filter(g => g.description && g.description.length > 10);
              const withPrice = games.filter(g => g.price);
              const withImage = games.filter(g => g.headerImage);
          
              console.log(\`âœ… æ•°æ®è´¨é‡æŠ¥å‘Š:\`);
              console.log(\`   - æœ‰æ•ˆæè¿°: \${withDesc.length}/\${games.length} (\${Math.round(withDesc.length/games.length*100)}%)\`);
              console.log(\`   - ä»·æ ¼ä¿¡æ¯: \${withPrice.length}/\${games.length} (\${Math.round(withPrice.length/games.length*100)}%)\`);
              console.log(\`   - æ¸¸æˆå›¾ç‰‡: \${withImage.length}/\${games.length} (\${Math.round(withImage.length/games.length*100)}%)\`);
          
              if (withDesc.length / games.length < 0.5) {
                console.log('âš ï¸ è­¦å‘Šï¼šæœ‰æ•ˆæ•°æ®æ¯”ä¾‹è¾ƒä½ï¼Œå¯èƒ½å­˜åœ¨è´¨é‡é—®é¢˜');
                process.exit(1);
              }
            } catch (error) {
              console.log('âŒ æ•°æ®è´¨é‡æ£€æŸ¥å¤±è´¥:', error.message);
              process.exit(1);
            }
          " | tee -a logs/fetch.log


      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯é¡¹ç›®
        if: steps.fetch_data.outputs.data_generated == 'true'
        run: |          
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºå‰ç«¯é¡¹ç›®..." | tee -a logs/fetch.log
          # æ„å»ºé¡¹ç›®
          pnpm run build
          
          # æ£€æŸ¥æ„å»ºäº§ç‰©
          if [ -d "dist" ]; then
            echo "âœ… æ„å»ºæˆåŠŸï¼Œäº§ç‰©å¤§å°:" | tee -a logs/fetch.log
            du -sh dist/ | tee -a logs/fetch.log
            ls -la dist/ | tee -a logs/fetch.log
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°distç›®å½•" | tee -a logs/fetch.log
            exit 1
          fi
        env:
          NODE_ENV: production

      - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
        if: steps.fetch_data.outputs.data_generated == 'true'
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°GitHub Pages..." | tee -a logs/fetch.log
          
          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†éƒ¨ç½²å¯†é’¥
          if [ -z "${{ secrets.DEPLOY_TOKEN }}" ]; then
            echo "âš ï¸ æœªé…ç½®DEPLOY_TOKENï¼Œä½¿ç”¨é»˜è®¤DEPLOY_TOKENï¼ˆå¯èƒ½æƒé™ä¸è¶³ï¼‰" | tee -a logs/fetch.log
            DEPLOY_TOKEN="${{ secrets.DEPLOY_TOKEN }}"
          else
            echo "âœ… ä½¿ç”¨é…ç½®çš„DEPLOY_TOKEN" | tee -a logs/fetch.log
            DEPLOY_TOKEN="${{ secrets.DEPLOY_TOKEN }}"
          fi
          
          # å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆä½¿ç”¨tokenè®¤è¯ï¼‰
          git clone https://${DEPLOY_TOKEN}@github.com/steamMonitor/steamMonitor.github.io.git pages-repo
          cd pages-repo
          
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config user.email "action@github.com"
          git config user.name "GitHub Action Bot"
          
          # æ£€æŸ¥å½“å‰åˆ†æ”¯
          current_branch=$(git branch --show-current)
          echo "ğŸ“‹ å½“å‰åˆ†æ”¯: $current_branch" | tee -a ../logs/fetch.log
          
          # å¦‚æœä¸æ˜¯mainåˆ†æ”¯ï¼Œåˆ‡æ¢åˆ°mainåˆ†æ”¯
          if [ "$current_branch" != "main" ]; then
            git checkout -b main 2>/dev/null || git checkout main
          fi
          
          # æ¸…ç©ºç°æœ‰å†…å®¹ï¼ˆä¿ç•™.gitç›®å½•å’ŒREADME.mdï¼‰
          find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' ! -name 'README.md' -exec rm -rf {} +
          
          # å¤åˆ¶æ„å»ºäº§ç‰©
          cp -r ../dist/* .
          
          # æ·»åŠ CNAMEæ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦è‡ªå®šä¹‰åŸŸåï¼Œè¯·å–æ¶ˆæ³¨é‡Šå¹¶ä¿®æ”¹åŸŸåï¼‰
           echo "steam.youseeyou1daydayde.uk" > CNAME
          
                   # æ·»åŠ .nojekyllæ–‡ä»¶ä»¥ç¦ç”¨Jekyllå¤„ç†
           touch .nojekyll
          
           # æ·»åŠ ç®€å•çš„READMEæ–‡ä»¶
           echo "# Steam Price Monitor" > README.md
           echo "" >> README.md
           echo "Steamä»·æ ¼ç›‘æ§åº”ç”¨ - è‡ªåŠ¨éƒ¨ç½²äº $(date '+%Y-%m-%d %H:%M:%S UTC')" >> README.md
           echo "" >> README.md
           echo "è®¿é—®: https://steammonitor.github.io" >> README.md
          
          # æäº¤å¹¶å¼ºåˆ¶æ¨é€
          git add .
          
          if git diff --cached --quiet; then
            echo "ğŸ“ æ„å»ºäº§ç‰©æ— å˜åŒ–ï¼Œè·³è¿‡éƒ¨ç½²" | tee -a ../logs/fetch.log
          else
            GAMES_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('../public/data/metadata.json', 'utf8')).gamesCount)" 2>/dev/null || echo "æœªçŸ¥")
          
            git commit -m "ğŸš€ è‡ªåŠ¨éƒ¨ç½²Steamä»·æ ¼ç›‘æ§åº”ç”¨ - $(date '+%Y-%m-%d %H:%M') - ${GAMES_COUNT}ä¸ªæ¸¸æˆ [skip ci]"
          
            echo "ğŸ“¤ å¼ºåˆ¶æ¨é€åˆ°GitHub Pages..." | tee -a ../logs/fetch.log
            git push --force origin main
          
            echo "âœ… éƒ¨ç½²å®Œæˆ!" | tee -a ../logs/fetch.log
            echo "ğŸŒ è®¿é—®åœ°å€: https://steammonitor.github.io" | tee -a ../logs/fetch.log
          fi
          
          cd ..
          rm -rf pages-repo
        env:
          DEPLOY_TOKEN: ${{  secrets.DEPLOY_TOKEN }}

      - name: ğŸ“‹ ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fetch-logs-${{ github.run_number }}
          path: logs/
          retention-days: 7

      - name: ğŸ“Š è¿è¡Œç»“æœæ€»ç»“
        if: always()
        run: |
          echo "=== ğŸš€ Steamæ•°æ®æ›´æ–°å’Œéƒ¨ç½²ä»»åŠ¡å®Œæˆ ===" | tee -a logs/fetch.log
          echo "â° è¿è¡Œæ—¶é—´: $(date)" | tee -a logs/fetch.log
          echo "ğŸ”§ è¿è¡Œæ¨¡å¼: ${{ github.event.inputs.mode || 'puppeteer' }}" | tee -a logs/fetch.log
          echo "ğŸ“Š ä»»åŠ¡çŠ¶æ€: ${{ job.status }}" | tee -a logs/fetch.log
          
          if [ "${{ steps.fetch_data.outputs.data_generated }}" = "true" ]; then
            echo "âœ… æ•°æ®ç”Ÿæˆ: æˆåŠŸ" | tee -a logs/fetch.log
            echo "âœ… å‰ç«¯æ„å»º: æˆåŠŸ" | tee -a logs/fetch.log
          
            if [ "${{ github.event.inputs.deploy }}" = "true" ] || [ "${{ github.event.inputs.deploy }}" = "" ]; then
              echo "âœ… GitHub Pageséƒ¨ç½²: æˆåŠŸ" | tee -a logs/fetch.log
              echo "ğŸŒ è®¿é—®åœ°å€: https://steammonitor.github.io" | tee -a logs/fetch.log
            else
              echo "â­ï¸ GitHub Pageséƒ¨ç½²: è·³è¿‡ï¼ˆæ‰‹åŠ¨ç¦ç”¨ï¼‰" | tee -a logs/fetch.log
            fi
          else
            echo "âŒ æ•°æ®ç”Ÿæˆ: å¤±è´¥" | tee -a logs/fetch.log
            echo "â­ï¸ å‰ç«¯æ„å»º: è·³è¿‡" | tee -a logs/fetch.log
            echo "â­ï¸ GitHub Pageséƒ¨ç½²: è·³è¿‡" | tee -a logs/fetch.log
          fi
          
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… æ•°æ®æäº¤: æˆåŠŸ" | tee -a logs/fetch.log
          else
            echo "ğŸ“ æ•°æ®æäº¤: æ— å˜åŒ–" | tee -a logs/fetch.log
          fi
          
          echo "ğŸ“ æ—¥å¿—æ–‡ä»¶å·²ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©" | tee -a logs/fetch.log
          
          # æ˜¾ç¤ºæœ€åå‡ è¡Œæ—¥å¿—
          echo "=== æœ€è¿‘çš„æ—¥å¿— ===" 
          tail -20 logs/fetch.log